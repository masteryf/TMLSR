# NGSR 项目使用说明

本项目封装了 ComfyUI 的 API 调用，支持并行处理和工作流自动转换。

## 📁 目录结构

- `utils/`: 包含核心工具代码
  - `comfy_utils.py`: ComfyUI 客户端及工作流处理类
- `workflows/`: 存放 ComfyUI 的 JSON 工作流文件
- `example_usage.py`: 使用示例代码

## ➕ 如何添加新工作流

本项目设计了自动转换功能，您可以直接使用 ComfyUI 保存的标准 JSON 文件，无需手动导出 API 格式。

### 第一步：在 ComfyUI 中设计并保存

1. 在 ComfyUI 网页端搭建好您的工作流。
2. 确保工作流中包含以下关键节点（以便程序自动识别）：
   - **输入图片**: 使用标准的 `LoadImage` 节点。
   - **输出图片**: 使用标准的 `SaveImage` 节点。
   - **随机种子** (可选): 如果需要控制随机性，程序会自动识别 `KSampler` 或 `SeedVR2VideoUpscaler` 等包含 `seed` 或 `noise_seed` 参数的节点。
3. 点击 ComfyUI 侧边栏的 **"Save"** 按钮，将工作流保存为 `.json` 文件（例如 `MyNewWorkflow.json`）。

### 第二步：放入项目目录

将下载的 `.json` 文件移动到项目的 `workflows/` 文件夹中：

```text
d:\Project\NGSR\workflows\MyNewWorkflow.json
```

### 第三步：在代码中调用

在您的 Python 代码中，只需指定新的 JSON 文件路径即可初始化 `NGSRWorkflow`。

```python
from utils.comfy_utils import NGSRWorkflow, ComfyUIClient

# 1. 初始化客户端
client = ComfyUIClient("localhost:8000")
client.connect()

# 2. 加载新工作流
# 这里的路径指向您刚才放入 workflows 文件夹的文件
workflow_file = "d:\\Project\\NGSR\\workflows\\MyNewWorkflow.json"
workflow = NGSRWorkflow(workflow_file, client)

# 3. 运行处理
# image_path: 本地图片路径
# output_dir: 结果保存目录
outputs = workflow.run("d:\\Project\\NGSR\\test_image.png", "d:\\Project\\NGSR\\output")

print(f"处理完成，结果保存在: {outputs}")
```

## ⚙️ 高级说明

### 自动参数映射
工具类 `utils/comfy_utils.py` 中的 `WorkflowConverter` 会自动处理以下逻辑：
- **UI 转 API**: 将 ComfyUI 的前端格式自动转换为后端 API 格式。
- **Widget 值处理**: 自动提取节点上的参数值（如降噪强度、步数等）。
- **种子控制**: 自动跳过 `control_after_generate` (如 randomize/fixed) 控件，直接设置种子数值。

### 并行调用
如果需要并行处理多张图片，请参考 `example_usage.py` 中的 `parallel_usage` 函数，利用 `ThreadPoolExecutor` 分发任务。
