<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMLSR Server Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .status-badge { width: 100px; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-light">
    <div id="app" class="container py-4" v-cloak>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>TMLSR Server Monitor</h1>
            <div>
                <span class="badge bg-secondary me-2">Last Updated: {{ lastUpdated }}</span>
                <button class="btn btn-primary btn-sm" @click="fetchData">Refresh</button>
            </div>
        </div>

        <!-- System Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Active Workers</h5>
                        <h2 class="card-text text-primary">{{ system.active_workers }} / {{ system.max_workers }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Queue Size</h5>
                        <h2 class="card-text text-warning">{{ system.queue_size }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Completed</h5>
                        <h2 class="card-text text-success">{{ stats.completed }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Failed</h5>
                        <h2 class="card-text text-danger">{{ stats.failed }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task List -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">Recent Tasks</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Task ID</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Created At</th>
                                <th>Params</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="task in tasks" :key="task.task_id">
                                <td>
                                    <small class="font-monospace text-muted">{{ task.task_id.substring(0, 8) }}...</small>
                                </td>
                                <td>
                                    <span class="badge bg-info text-dark" v-if="task.params.type === 'image'">Image</span>
                                    <span class="badge bg-primary" v-else>Video</span>
                                </td>
                                <td>
                                    <span :class="'badge status-badge ' + getStatusClass(task.status)">
                                        {{ task.status }}
                                    </span>
                                </td>
                                <td>{{ formatTime(task.created_at) }}</td>
                                <td>
                                    <small>
                                        Scale: {{ task.params.outscale || 4 }}x <br>
                                        <span v-if="task.params.output_magnification">Mag: {{ task.params.output_magnification }}x</span>
                                    </small>
                                </td>
                                <td>
                                    <div v-if="task.status === 'processing'">
                                        <small class="text-muted" v-if="task.stages.length > 0">
                                            Last stage: {{ task.stages[task.stages.length-1].name }}
                                        </small>
                                    </div>
                                    <div v-else-if="task.status === 'completed'">
                                        <a :href="task.output?.url" target="_blank" class="btn btn-sm btn-outline-success">Download</a>
                                    </div>
                                    <div v-else-if="task.status === 'failed'">
                                        <small class="text-danger text-truncate d-inline-block" style="max-width: 150px;" :title="task.error">
                                            {{ task.error }}
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" @click="showDetails(task)">
                                        Details
                                    </button>
                                    <button v-if="['pending', 'processing'].includes(task.status)" 
                                            class="btn btn-sm btn-outline-danger"
                                            @click="cancelTask(task.task_id)">
                                        Cancel
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="tasks.length === 0">
                                <td colspan="7" class="text-center py-4 text-muted">No tasks found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Task Details Modal -->
        <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Task Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" v-if="selectedTask">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Task ID:</strong> <span class="font-monospace">{{ selectedTask.task_id }}</span>
                            </div>
                            <div class="col-md-6 text-end">
                                <strong>Status:</strong> 
                                <span :class="'badge ' + getStatusClass(selectedTask.status)">{{ selectedTask.status }}</span>
                            </div>
                        </div>

                        <h6 class="border-bottom pb-2">Stages</h6>
                        <div class="list-group list-group-flush">
                            <div v-for="stage in selectedTask.stages" :key="stage.name" class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <strong>{{ stage.name.toUpperCase() }}</strong>
                                    <span :class="'badge ' + (stage.status === 'success' ? 'bg-success' : (stage.status === 'running' ? 'bg-primary' : 'bg-secondary'))">
                                        {{ stage.status }}
                                    </span>
                                </div>
                                
                                <div class="d-flex justify-content-between small text-muted mb-1">
                                    <span>{{ stage.detail || '-' }}</span>
                                    <span>{{ stage.duration ? stage.duration + 's' : '' }}</span>
                                </div>

                                <div class="progress" style="height: 10px;" v-if="stage.status === 'running' || stage.status === 'success'">
                                    <div class="progress-bar progress-bar-striped" 
                                         :class="stage.status === 'running' ? 'progress-bar-animated' : 'bg-success'"
                                         role="progressbar" 
                                         :style="{ width: (stage.progress || (stage.status === 'success' ? 100 : 0)) + '%' }">
                                    </div>
                                </div>
                            </div>
                            <div v-if="selectedTask.stages.length === 0" class="text-muted text-center py-3">
                                No stages recorded yet.
                            </div>
                        </div>

                        <div v-if="selectedTask.output" class="mt-4 pt-3 border-top">
                            <h6>Output</h6>
                            <p>
                                <a :href="selectedTask.output.url" target="_blank">{{ selectedTask.output.url }}</a>
                                <span class="text-muted ms-2">({{ selectedTask.output.size_mb }} MB)</span>
                            </p>
                        </div>
                        
                        <div v-if="selectedTask.error" class="mt-4 pt-3 border-top">
                            <h6 class="text-danger">Error</h6>
                            <pre class="bg-light p-2 text-danger small">{{ selectedTask.error }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    system: { max_workers: 0, active_workers: 0, queue_size: 0 },
                    stats: { completed: 0, failed: 0 },
                    tasks: [],
                    lastUpdated: '-',
                    timer: null,
                    selectedTask: null,
                    detailsModal: null
                }
            },
            methods: {
                async fetchData() {
                    try {
                        const res = await axios.get('/monitor/stats');
                        this.system = res.data.system;
                        this.stats = res.data.stats;
                        this.tasks = res.data.tasks;
                        this.lastUpdated = new Date().toLocaleTimeString();
                        
                        // Update selected task if open
                        if (this.selectedTask) {
                            const updated = this.tasks.find(t => t.task_id === this.selectedTask.task_id);
                            if (updated) {
                                this.selectedTask = updated;
                            }
                        }
                    } catch (err) {
                        console.error("Failed to fetch stats", err);
                    }
                },
                getStatusClass(status) {
                    const map = {
                        'pending': 'bg-secondary',
                        'processing': 'bg-warning text-dark',
                        'completed': 'bg-success',
                        'failed': 'bg-danger',
                        'canceled': 'bg-dark'
                    };
                    return map[status] || 'bg-secondary';
                },
                formatTime(isoStr) {
                    if (!isoStr) return '-';
                    return new Date(isoStr).toLocaleString();
                },
                async cancelTask(taskId) {
                    if (!confirm('Are you sure you want to cancel this task?')) return;
                    try {
                        await axios.delete(`/tasks/${taskId}`);
                        this.fetchData();
                    } catch (err) {
                        alert('Failed to cancel task: ' + (err.response?.data?.detail || err.message));
                    }
                },
                showDetails(task) {
                    this.selectedTask = task;
                    if (!this.detailsModal) {
                        this.detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
                    }
                    this.detailsModal.show();
                }
            },
            mounted() {
                this.fetchData();
                this.timer = setInterval(this.fetchData, 3000); // Refresh every 3s
            },
            beforeUnmount() {
                if (this.timer) clearInterval(this.timer);
            }
        }).mount('#app');
    </script>
</body>
</html>
